<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
   <title th:text="|${pageName}|"></title>
    <link rel="stylesheet" th:href="@{/css/nav.css}">
	<link rel="stylesheet" th:href="@{/css/nav_보현.css}">
    <link rel="stylesheet" th:href="@{/css/find-password.css}">
	<link rel="stylesheet" th:href="@{/css/scroll.css}">
	<!-- Bootstrap CSS CDN -->
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	<!-- Bootstrap Icons CDN -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
	<!-- Bootstrap Date Range Picker CSS -->
	<link href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" rel="stylesheet">

</head>
<div class="header">
<!-- 네비게이션 바 -->
<div th:insert="~{nav :: nav}"></div>
<!-- 네비게이션 바의 높이만큼 여백을 주어 콘텐츠가 네비게이션 바 아래에 위치하도록 함 -->
	<div style="height: 60px;"></div> 
</div>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="findpassword">
                    <h1 class="text-center mb-4">비밀번호 찾기</h1>

                    <!-- 이메일 입력 및 인증번호 요청 폼 -->
                    <form id="emailForm" action="/api/v1/email/send" method="POST">
                        <div class="form-group">
                            <label for="uEmail">가입 시 등록한 이메일</label>
                            <input type="email" class="form-control" id="uEmail" name="uEmail"placeholder="이메일을 입력하세요" required />
                            <button type="submit" class="btn btn-success">인증 코드 보내기</button>
                        </div>
                    </form>

                    <!-- 인증 코드 입력 폼 -->
                    <form id="verifyCodeForm">
                        <div class="form-group">
                            <label for="verifyCode">인증 코드</label>
                            <input type="text" class="form-control" id="verifyCode" name="verifyCode" placeholder="인증번호를 입력하세요" required />
                            <!-- hidden 필드에 이메일 값을 저장 -->
                            <input type="hidden" id="uEmailHidden" name="uEmail" />
                            <button type="submit" class="btn btn-success"> 임시 비밀번호 발송 </button>
                        </div>
                    </form>
                </div>

                <!-- 오류 메시지 출력 -->
                <div th:if="${error}" class="alert alert-danger mt-4" role="alert">
                    <p th:text="${error}"></p>
                </div>
            </div>
        </div>
    </div>
	<!-- 스크롤 업-->
	<div>
		<i class="bi bi-arrow-up-square-fill" id="scrollUpIcon"></i>
	</div>
	<div th:replace="~{footer :: footer}"></div>
	<!-- jQuery (필수) -->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<!-- Bootstrap JS and dependencies -->
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
	<!-- Moment.js (필수) -->
	<script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
	<!-- Bootstrap Date Range Picker JS -->
	<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
	<!-- 스크립트 -->
	<script th:src="@{/js/page_nav.js}" type="text/javascript"></script>
	<script th:src="@{/js/scroll.js}" type="text/javascript"></script>
	
    <script>
        $(document).ready(function() {
            // 이메일 발송 폼 처리
            $('#emailForm').on('submit', function(event) {
                event.preventDefault();  // 폼 기본 제출 동작 막기
                var email = $('#uEmail').val();

                // 이메일 발송 요청
                $.ajax({
                    type: 'POST',
                    url: '/security-login/send-email',  // 인증 코드 발송 URL
                    data: JSON.stringify({ mail: email }),
                    contentType: 'application/json; charset=utf-8',
                    success: function(response) {
                        alert('이메일로 인증 코드를 보냈습니다.');
                        $('#uEmailHidden').val(email);  // 인증 코드 폼에서 이메일을 전달하기 위해 hidden input에 저장
                    },
                    error: function() {
                        alert('인증 코드 발송에 실패했습니다.');
                    }
                });
            });

            // 인증 코드 확인 및 임시 비밀번호 발송
            $('#verifyCodeForm').on('submit', function(event) {
                event.preventDefault();  // 폼 기본 제출 동작 막기
                var verifyCode = $('#verifyCode').val();
                var email = $('#uEmailHidden').val();  // hidden input에서 이메일 값 가져오기

                // 인증 코드 확인 및 임시 비밀번호 발송 요청
                $.ajax({
                    type: 'POST',
                    url: '/security-login/find-password',  // 인증 코드 검증 및 임시 비밀번호 발송 URL
                    data: JSON.stringify({ mail: email, verifyCode: verifyCode }),  // mail과 verifyCode 전달
                    contentType: 'application/json; charset=utf-8',
                    success: function(response) {
                        alert('인증이 완료되었습니다. 임시 비밀번호가 이메일로 발송되었습니다.');
                        window.location.href = "/security-login/find-password-result";  // 임시 비밀번호 발송 후 결과 페이지로 이동
                    },
                    error: function() {
                        alert('인증에 실패했습니다. 코드를 다시 확인해주세요.');
                    }
                });
            });
        });
    </script>

</body>
</html>
